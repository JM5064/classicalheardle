<!DOCTYPE html>
<html>
    <head>
      <title>Classical Music Heardle</title>

      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
      
      <link rel="stylesheet" href="website.css">

    </head>

    <body>
      <div id="guesses-list"></div>

      <button id="mode-button" onclick="switchMode();">
        Switch Theme
      </button>

      <p class="title">
        Classicle
      </p>
      <div id="g1" class="guess1"></div>
      <div id="g2" class="guess2"></div>
      <div id="g3" class="guess3"></div>
      <div id="g4" class="guess4"></div>
      <div id="g5" class="guess5"></div>
      <div id="g6" class="guess6"></div>
      
      <div>
        <audio controls src="Mzg1ODMxNTIzMzg1ODM3_JzthsfvUY24.MP3">

        </audio>
      </div>
      
      <form autocomplete="off">
        <div>
          <input type="text" id="guess-input" class="search" placeholder="Guess Piece">
        </div>
      </form>

      <div>
        <button id="skip-button"
          class="skip">
          SKIP (+1s)
        </button>  
      </div>

      <div>
        <button id="submit"
          class="submit">
          SUBMIT
        </button>  
      </div>

      <script>

        function switchMode () {
          var element = document.body;
          document.getElementById('submit').classList.toggle('light-mode');
          element.classList.toggle('light-mode');

        }
        
        function readTextFile(file, callback) {
          var rawFile = new XMLHttpRequest();
          rawFile.open("GET", file, true);
          rawFile.onreadystatechange = function() {
            if (rawFile.readyState === 4 && rawFile.status == "200") {
                callback(rawFile.responseText);
            }
          }
          rawFile.send(null);
        }

        var data;

        readTextFile("openopus.json", function(text){
            data = JSON.parse(text);
            console.log(data);
        });


        let guesses = [];
        let numGuesses = 0;

        focus = -1;

        function closeAutofill() {
          focus = -1;
          let divs = document.getElementsByClassName("autocomplete-items");
          let l = divs.length;
          for (let i = 0; i < l; i++) {
            divs[0].parentNode.removeChild(divs[0]);
          }
        }

        autofill(document.getElementById("guess-input"));

        function removeSpecialCharacters(str) {
          return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function autofill(input) {

          input.addEventListener("input", function(e) {
            closeAutofill();
            var max = 50;
            let inp = removeSpecialCharacters(input.value.toUpperCase());

            for (let i = 0; i < data.composers.length; i++) {
              for (let j = 0; j < data.composers[i].works.length; j++) {
                let origPiece = data.composers[i].works[j].title + " - " + data.composers[i].complete_name;
                let piece = removeSpecialCharacters(origPiece);

                if (piece.toUpperCase().includes(inp) && (data.composers[i].works[j].popular == "1"
                  // || data.composers[i].works[j].recommended == "1"
                  )
                ) {
                  var e2;
                  if (document.getElementsByClassName("autocomplete-items").length < max) {
                    e = document.createElement('div');
                    e.setAttribute("class", "autocomplete-items");
                    e2 = document.createElement('div');
                    e2.setAttribute("class", "autocomplete-items-text");
                    e2.setAttribute("id", i);
                    
                    if (!piece.toUpperCase().includes(inp)) {
                      e2.innerHTML = origPiece;
                    } else {
                      e2.innerHTML = origPiece.substring(0, piece.toUpperCase().indexOf(inp));
                      e2.innerHTML += "<span class='letter-highlight'>" + origPiece.substring(piece.toUpperCase().indexOf(inp), piece.toUpperCase().indexOf(inp) + inp.length) + "</span>";
                      e2.innerHTML += origPiece.substring(piece.toUpperCase().indexOf(inp) + inp.length);
                    }

                    e.appendChild(e2);
                    document.body.appendChild(e);

                    } else {
                      break;
                    }
                  
                  e2.addEventListener("click", function(e) {
                    document.getElementById('guess-input').value = origPiece;
                    closeAutofill();
                  });
                }

              }
            }
            var fn = document.createElement('div');
            fn.setAttribute("class", "autocomplete-items");
            var fn2 = document.createElement('div');
            fn2.setAttribute("class", "footnote");
            fn2.innerHTML = "Showing " + document.getElementsByClassName("autocomplete-items").length + " results for \"" + input.value + "\"";
            fn.appendChild(fn2);
            document.body.appendChild(fn);

            if (document.getElementById('guess-input').value == '') {
              closeAutofill();
            }

          });


        input.addEventListener("keydown", function(e){
          if (e.keyCode == 38) { // up
            focus--;
            if (focus < 0) {
              focus = document.getElementsByClassName("autocomplete-items-text").length - 1;
            }
            clearHighlight();
            document.getElementsByClassName("autocomplete-items-text")[focus].classList.add("autocomplete-item-highlight");
          } else if (e.keyCode == 40) { // down
            focus++;
            if (focus > document.getElementsByClassName("autocomplete-items-text").length - 1) {
              focus = 0;
            }
            clearHighlight();
            document.getElementsByClassName("autocomplete-items-text")[focus].classList.add("autocomplete-item-highlight");
          
          } else if (e.keyCode == 13) { // enter
            e.preventDefault();
            // let piece = data.composers[i].works[j].title + " - " + data.composers[i].complete_name;
            let num = document.getElementsByClassName("autocomplete-items-text")[focus].id;
            document.getElementById('guess-input').value = pieces[num].title + " - "  + pieces[num].composer;
            closeAutofill();
          }
        });

        function clearHighlight(){
          for (let i = 0; i < document.getElementsByClassName("autocomplete-items-text").length; i++) {
            document.getElementsByClassName("autocomplete-items-text")[i].classList.remove("autocomplete-item-highlight");
          }
        }


      }

        document.addEventListener("click", function(e) {
          closeAutofill();
        });

        function render_guesses() {
          document.getElementById("guesses-list").innerHTML = '';
          document.getElementById('g' + guesses.length).textContent += guesses[guesses.length - 1];        
        }

        const submitHover = document.getElementById('submit');
        submitHover.addEventListener('click', function(e) {
          addGuess(document.getElementById('guess-input').value);
          document.getElementById('guess-input').value = '';
          render_skip_time()
        });

        const skipHover = document.getElementById('skip-button');
        skipHover.addEventListener('click', function(e) {
          addGuess('S K I P P E D');
          document.getElementById('guess-input').value = '';
          render_skip_time()
        });


        function addGuess(guess) {
          if (numGuesses < 6 && guess != '') {
            guesses.push(guess);
            render_guesses();
            numGuesses++; 
          }
        }


        function render_skip_time() {
          document.getElementById('skip-button').innerHTML = '';
          if (numGuesses < 5) {
            document.getElementById('skip-button').textContent = 'SKIP (+' + (numGuesses + 1) + "s)";
          } else {
            document.getElementById('skip-button').textContent = 'SKIP';
          }
        }


      </script>


    </body>
</html>
